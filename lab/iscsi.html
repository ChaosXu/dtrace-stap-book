<html>
<head>
	<meta charset="utf-8" /> 
	<meta http-equiv="Content-Type" content="text/html">
	<meta name="generator" content="TSDoc 0.2">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	
	<title>Appendix B. Lab setup</title>
	
	<link rel="stylesheet" href="../bootstrap/css/bootstrap.css" />
	<link href="../bootstrap/css/bootstrap-responsive.css" rel="stylesheet" media="screen,handheld"/>
	
	<script type="text/javascript">
	function toggleCode(id) {
		code = document.getElementById(id);
		hideClass = 'hide';
		
		if(code.classList.contains(hideClass))
			code.classList.remove(hideClass);
		else
			code.classList.add(hideClass);
	}
	</script>
	
	<script>
        (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
        (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
        m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
        })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

        ga('create', 'UA-71659121-1', 'auto');
        ga('send', 'pageview');
    </script>
</head>
<body>

<!-- HEADER -->

<div class="navbar">
    <div class="navbar-inner">
	    <div class="container">
			<a class="brand" href="../index.html">Dynamic Tracing with DTrace & SystemTap</a><ul class="nav pull-left">
<li><a href="os.html"><strong>Prev</strong>(Setting up Operating Systems)</a></li>
</ul>
<ul class="nav pull-right">
<li><a href="web.html"><strong>Next</strong>(Web application stack)</a></li>
</ul>
		</div>
    </div>
</div>

<div class="container max-height no-overflow">
	<div id="content" nevow:render="content">
		<p>
<h3>iSCSI</h3></p>
<p>
We will need to use SCSI device so we can fully trace it in <a href="../kernel/ex5.html">exercise 5</a>. Xen hypervisor supports SCSI emulation, but only by emulating outdated <em>LSI 53c895a</em> controller which is not supported by Solaris. However, we can create iSCSI devices in Dom0 and supply them to virtual machines. The following guide is created for Debian 7 which uses <em>iSCSI Enterprise Target</em>. Recent Linux kernels replaced it with <em>LIO</em> stack.<br /></p>
<p>
    <ul>
        <li>
 Install IET packages:<br />            <p>
            <pre>
# aptitude install iscsitarget iscsitarget-dkms
</pre>
</p>
</li>
        <li>
 Create logical disks for virtual machines. They would be LVM volumes <code>/dev/mapper/vgmain-sol11--base--lab</code> and <code>/dev/mapper/vgmain-centos7--base--lab</code> in our example.<br /> </li>
        <li>
 Create targets in <code>/etc/iet/ietd.conf</code> file by adding following lines:<br />            <p>
            <pre>
Target iqn.2154-04.tdc.r520:storage.lab5-sol11-base
    Lun 0 Path=/dev/mapper/vgmain-sol11--base--lab,Type=blockio

Target iqn.2154-04.tdc.r520:storage.lab5-centos7-base
    Lun 0 Path=/dev/mapper/vgmain-centos7--base--lab,Type=blockio
</pre>
</p>
Note that target names should match DNS name of a host which provides them.<br /> </li>
        <li>
 Configure <code>/etc/iet/initiators.allow</code> file to forbid Solaris access to disk allocated for CentOS machine and vice versa. Delete or comment out <code>ALL ALL</code> line and add lines with target names and IP addresses of corresponding machines:<br />            <p>
            <pre>
iqn.2154-04.tdc.r520:storage.lab5-sol11-base    192.168.50.179
iqn.2154-04.tdc.r520:storage.lab5-centos7-base  192.168.50.171
</pre>
</p>
</li>
        <li>
 Restart IET daemon:<br />            <p>
            <pre>
# /etc/init.d/iscsitarget restart
</pre>
</p>
</li>
        <li>
 Configure Solaris initiator. <code>192.168.50.116</code> is an IP address of our Dom0 system which provides iSCSI targets.<br />            <p>
            <pre>
# iscsiadm add discovery-address 192.168.50.116
# iscsiadm modify discovery -t enable
# svcadm restart svc:/network/iscsi/initiator:default
</pre>
</p>
</li>
        <li>
 Similarly configure CentOS initiator:<br />            <p>
            <pre>
# yum install iscsi-initiator-utils
# systemctl enable iscsid
# systemctl start iscsid
# iscsiadm -m discovery -t sendtargets -p 192.168.50.116
# iscsiadm -m node --login
</pre>
</p>
</li>
</ul>
</p>

	</div>
</div>

<!-- TAIL -->

<div class="navbar navbar-bottom">
    <div class="navbar-inner">
        <div class="container">
            <ul class="nav pull-left">
<li><a href="os.html"><strong>Prev</strong>(Setting up Operating Systems)</a></li>
</ul>
<ul class="nav pull-center">
<li><a href="../index.html"><strong>Up</strong>(Dynamic Tracing with DTrace & SystemTap)</a></li>
</ul>
<ul class="nav pull-right">
<li><a href="web.html"><strong>Next</strong>(Web application stack)</a></li>
</ul>
        </div>
    </div>
</div>

<ul class="breadcrumb">
    <li><a href="https://github.com/myaut/dtrace-stap-book"><small>GitHub</small></a> <span class="divider">|</span></li>
    <li><a href="https://bitbucket.org/sergey_klyaus/dtrace-stap-book"><small>BitBucket</small></a> <span class="divider">|</span></li>
    <li style="float: right; ">
        <small>
        Published under terms of <a href="https://creativecommons.org/licenses/by-nc-sa/3.0/">CC-BY-NC-SA 3.0</a> license.
        </small>
    </li>
</ul>
</body>
</html>