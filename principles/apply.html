<html>
<head>
	<meta charset="utf-8" /> 
	<meta http-equiv="Content-Type" content="text/html">
	<meta name="generator" content="TSDoc 0.2">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	
	<title> Module 3: Principles of dynamic tracing
</title>
	
	<link rel="stylesheet" href="../bootstrap/css/bootstrap.css" />
	<link href="../bootstrap/css/bootstrap-responsive.css" rel="stylesheet" media="screen,handheld"/>
	
	<script type="text/javascript">
	function toggleCode(id) {
		code = document.getElementById(id);
		hideClass = 'hide';
		
		if(code.classList.contains(hideClass))
			code.classList.remove(hideClass);
		else
			code.classList.add(hideClass);
	}
	</script>
	
	<script>
        (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
        (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
        m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
        })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

        ga('create', 'UA-71659121-1', 'auto');
        ga('send', 'pageview');
    </script>
</head>
<body>

<!-- HEADER -->

<div class="navbar">
    <div class="navbar-inner">
	    <div class="container">
			<a class="brand" href="../index.html">Dynamic Tracing with DTrace & SystemTap</a><ul class="nav pull-right">
<li><a href="dyncode.html"><strong>Next</strong>(Dynamic code analysis)</a></li>
</ul>
		</div>
    </div>
</div>

<div class="container max-height no-overflow">
	<div id="content" nevow:render="content">
		<h3>
 Applying tracing</h3>
<p>
As we mentioned in <a href="../tools/tracing.html">Tracing</a>, it is used for statistics collection and performance analysis, dynamic kernel or application debug, system audit. Imagine the situation in which various processes running by two different users are opening files:</p>
<p>
<img src="../images/catfiles.png" alt="image:catfiles" class="img-rounded"/></p>
<p>
What problems can occur and how they are solved by dynamic tracing? Users can complain to very slow opening of a file, so we need to do <em>performance analysis</em>. First of all, we have confirm user complaints by measuring time spent in <code>open()</code>, <code>read()</code> and <code>write()</code> system calls. We can also try to cross-reference slow calls and filesystems on which they occur (by gathering mount paths), if problems are caused by bad NAS or disk. If the problem still exists, than you will need to go down VFS stack, i.e. by measuring time spent in block I/O or in lookup operations. </p>
<p>
If user encounters errors while opening files, then you will need to trace <code>errno</code> values. These values are usually returned by system call functions in Linux, or saved into <code>errno</code> variable in DTrace. To determine why system call returns an error, you will need <em>dynamically debug</em> it by checking return values of callees. We will demonstrate it in following section. If users try to attempt files they do not have permissions, we can record <code>errno</code> along with paths and user ids, so by doing that we will perform <em>system audit</em>. </p>
<p>
To demonstrate it on real example, we will use following examples and run <code>cat /etc/shadow</code> from some non-root user:
    <p>
    <pre>
# dtrace -qn '
    syscall::open*:entry { 
        printf("=> uid: %d pid: %d open: %s %lld\n", 
            uid, pid, copyinstr(arg1), (long long) timestamp); 
    } 
    syscall::open*:return { 
        printf("<= uid: %d pid: %d ret: %d %lld\n", 
                uid, pid, arg1, (long long) timestamp); 
    }'</pre>
</p>
</p>
<p>
SystemTap version:
    <p>
    <pre>
# stap -e '
    probe syscall.open { 
        printf("=> uid: %d pid: %d open: %s %d\n", 
            uid(), pid(), filename, local_clock_ns()); 
    } 
    probe syscall.open.return {  
        printf("<= uid: %d pid: %d %d %d\n", 
            uid(), pid(), $return, local_clock_ns()); 
    }'</pre>
</p>
</p>
<p>
Here is sample output:
    <p>
    <pre>
=> uid: 60004 pid: 1456 open: /etc/shadow 16208212467213
<= uid: 60004 pid: 1456 ret: -1 16208212482430</pre>
</p>
</p>
<p>
First of all, we measured time spent for <code>open()</code> system call: <code>16208212482430 â€” 16208212467213 = 15217 = 15.2 us</code>. We can also see that user received an error (return code is <code>-1</code>, while in case of correct call it would be positive) and now we may try to seek for a source of a problem. Finally, we have audited attempt to open critical system file <code>/etc/shadow</code> which is forbidden for users. So now we should find user name with id 60004 and politely ask him why he tried to open <code>/etc/shadow</code> file.</p>
<p>
We will discuss how trace data may be analysed and what conclusion can be made from it in this module. However, we will not introduce useful kernel or application probes as we will discuss them in modules 4, 5. On the other hand, all examples in following modules will be pure tracers, so you will need to add additional processing of results which will be discussed in this module.
</p>

	</div>
</div>

<!-- TAIL -->

<div class="navbar navbar-bottom">
    <div class="navbar-inner">
        <div class="container">
            <ul class="nav pull-center">
<li><a href="../index.html"><strong>Up</strong>(Dynamic Tracing with DTrace & SystemTap)</a></li>
</ul>
<ul class="nav pull-right">
<li><a href="dyncode.html"><strong>Next</strong>(Dynamic code analysis)</a></li>
</ul>
        </div>
    </div>
</div>

<ul class="breadcrumb">
    <li><a href="https://github.com/myaut/dtrace-stap-book"><small>GitHub</small></a> <span class="divider">|</span></li>
    <li><a href="https://bitbucket.org/sergey_klyaus/dtrace-stap-book"><small>BitBucket</small></a> <span class="divider">|</span></li>
    <li style="float: right; ">
        <small>
        Published under terms of <a href="https://creativecommons.org/licenses/by-nc-sa/3.0/">CC-BY-NC-SA 3.0</a> license.
        </small>
    </li>
</ul>
</body>
</html>