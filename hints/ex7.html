<html>
<head>
	<meta charset="utf-8" /> 
	<meta http-equiv="Content-Type" content="text/html">
	<meta name="generator" content="TSDoc 0.2">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	
	<title> Appendix A. Exercise hints and solutions 
</title>
	
	<link rel="stylesheet" href="../bootstrap/css/bootstrap.css" />
	<link href="../bootstrap/css/bootstrap-responsive.css" rel="stylesheet" media="screen,handheld"/>
	
	<script type="text/javascript">
	function toggleCode(id) {
		code = document.getElementById(id);
		hideClass = 'hide';
		
		if(code.classList.contains(hideClass))
			code.classList.remove(hideClass);
		else
			code.classList.add(hideClass);
	}
	</script>
	
	<script>
        (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
        (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
        m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
        })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

        ga('create', 'UA-71659121-1', 'auto');
        ga('send', 'pageview');
    </script>
</head>
<body>

<!-- HEADER -->

<div class="navbar">
    <div class="navbar-inner">
	    <div class="container">
			<a class="brand" href="../index.html">Dynamic Tracing with DTrace & SystemTap</a><ul class="nav pull-left">
<li><a href="ex6.html"><strong>Prev</strong>(Exercise 6)</a></li>
</ul>
		</div>
    </div>
</div>

<div class="container max-height no-overflow">
	<div id="content" nevow:render="content">
		<h3>
 Exercise 7</h3>
<p>
Nature of solution of this exercise depends on your Apache and PHP configuration. In our case (as described in <a href="../lab/web.html">lab description</a>), PHP was built as Apache HTTPD module (by using <code>--with-apxs2</code> option of <code>configure</code>-script), so all PHP code will be executed in a context of Apache worker, so we can safely use Thread-Local variables. If PHP was deployed with PHP-FPM, things would be more complicated.</p>
<p>
So we will need to use <code>process-request-entry</code> probe to get URI of request and pair of probes <code>function-entry</code>/<code>function-entry</code> to measure execution time of a function. Since name of a method is passed in multiple probe arguments, we will have to use string concatenation. Like in many other exercises, we will use aggregations to collect statistics. Note that you can use PHP probe <code>request-startup</code> instead of <code>process-request-entry</code>.</p>
<p>
As you could remember from a <a href="../principles/profiling.html">profiling</a> section of tracing principles, generally you shouldn't measure execution time of a function by tracing entry and exit points of it. However, PHP is an interpreted language, so it has lesser relative overheads of tracing because execution of its opcodes is slower than for the real processor (unless you are using some precompiler to machine language like HHVM) and we can afford full-tracing of it.</p>
<p>
Here are resulting implementations of scripts for SystemTap and DTrace:</p>
<p>
    <p>
    <div class="well">
<button class="btn" onclick="toggleCode('code1')">+</button>&nbsp; Script file topphp.stp <br/><p>
<pre id="code1" class="hide">
@define httpd %( "/usr/local/apache2/bin/httpd" %)
@define libphp5 %( "/usr/local/apache2/modules/libphp5.so" %)

global rquri, starttime, functime;

probe process(@httpd).mark("process__request__entry") {
    rquri[tid()] = user_string($arg2);
}

probe process(@libphp5).mark("function__entry") {
    starttime[tid()] = gettimeofday_ns();
}

probe process(@libphp5).mark("function__return") {
    if(starttime[tid()] == 0) next;

    func = user_string($arg4) . user_string($arg5) . user_string($arg1);
    functime[func, rquri[tid()]] <<< (gettimeofday_ns() - starttime[tid()]);
}

probe end {
    foreach([func, uri] in functime) {
        printf("%40s %32s %8d %d\n", func, uri,
               @count(functime[func, uri]), @avg(functime[func, uri]));
    }
}</pre>
</p>
</div>
</p>
    <p>
    <div class="well">
<button class="btn" onclick="toggleCode('code2')">+</button>&nbsp; Script file topphp.d <br/><p>
<pre id="code2" class="hide">
ap*:::process-request-entry {
    self->uri = copyinstr(arg1);
}

php*:::function-entry {
    self->starttime = timestamp;
}

php*:::function-return 
/ self->starttime != 0 / {
    this->func = strjoin(copyinstr(arg3), 
                         strjoin(copyinstr(arg4), copyinstr(arg0)));
    @[this->func, self->uri] = avg(timestamp - self->starttime);
}

END {
    printa(@);
}</pre>
</p>
</div>
</p>
</p>

	</div>
</div>

<!-- TAIL -->

<div class="navbar navbar-bottom">
    <div class="navbar-inner">
        <div class="container">
            <ul class="nav pull-left">
<li><a href="ex6.html"><strong>Prev</strong>(Exercise 6)</a></li>
</ul>
<ul class="nav pull-center">
<li><a href="../index.html"><strong>Up</strong>(Dynamic Tracing with DTrace & SystemTap)</a></li>
</ul>
        </div>
    </div>
</div>

<ul class="breadcrumb">
    <li><a href="https://github.com/myaut/dtrace-stap-book"><small>GitHub</small></a> <span class="divider">|</span></li>
    <li><a href="https://bitbucket.org/sergey_klyaus/dtrace-stap-book"><small>BitBucket</small></a> <span class="divider">|</span></li>
    <li style="float: right; ">
        <small>
        Published under terms of <a href="https://creativecommons.org/licenses/by-nc-sa/3.0/">CC-BY-NC-SA 3.0</a> license.
        </small>
    </li>
</ul>
</body>
</html>