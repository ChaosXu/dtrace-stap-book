<html>
<head>
	<meta charset="utf-8" /> 
	<meta http-equiv="Content-Type" content="text/html">
	<meta name="generator" content="TSDoc 0.2">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	
	<title> Appendix A. Exercise hints and solutions 
</title>
	
	<link rel="stylesheet" href="../bootstrap/css/bootstrap.css" />
	<link href="../bootstrap/css/bootstrap-responsive.css" rel="stylesheet" media="screen,handheld"/>
	
	<script type="text/javascript">
	function toggleCode(id) {
		code = document.getElementById(id);
		hideClass = 'hide';
		
		if(code.classList.contains(hideClass))
			code.classList.remove(hideClass);
		else
			code.classList.add(hideClass);
	}
	</script>
	
	<script>
        (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
        (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
        m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
        })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

        ga('create', 'UA-71659121-1', 'auto');
        ga('send', 'pageview');
    </script>
</head>
<body>

<!-- HEADER -->

<div class="navbar">
    <div class="navbar-inner">
	    <div class="container">
			<a class="brand" href="../index.html">Dynamic Tracing with DTrace & SystemTap</a><ul class="nav pull-left">
<li><a href="ex5.html"><strong>Prev</strong>(Exercise 5)</a></li>
</ul>
<ul class="nav pull-right">
<li><a href="ex7.html"><strong>Next</strong>(Exercise 7)</a></li>
</ul>
		</div>
    </div>
</div>

<div class="container max-height no-overflow">
	<div id="content" nevow:render="content">
		<h3>
 Exercise 6</h3>
<p>
This exercise is not so different than any <a href="../principles/perf.html#latency">latency measurement</a> script where latency is measured as difference between timestamps of two probe firings and saved to an aggregation. </p>
<p>
Note that <code>plockstat$</code> provider doesn't serve a probe for mutex lock attempt, so we had to expand it by using <code>pid$</code> provider. As you may notice from ustack outputs in <code>pthread.d</code> example, mutex lock attempts are implemented by <code>mutex_lock_impl()</code> libc function. We will use <code>quantize()</code> aggregation which will be printed with <code>printa</code>:</p>
<p>
    <p>
    <div class="well">
<button class="btn" onclick="toggleCode('code1')">+</button>&nbsp; Script file mtxtime.d <br/><p>
<pre id="code1" class="hide">
pid$target::mutex_lock_impl:entry
{ 
    self->mtxtime = timestamp; 
}

plockstat$target:::mutex-acquire
/ self->mtxtime != 0 /
{ 
    @[ustack()] = quantize(timestamp - self->mtxtime);
    self->mtxtime = 0;
}

pid$target::experiment_unconfigure:entry
{
    printa(@);
}</pre>
</p>
</div>
</p>

You will need to bind this script to tsexperiment process using <code>-c</code> or <code>-p</code> option.</p>
<p>
We will need to use static probes <code>mutex_entry</code> and <code>mutex_acquired</code> for a SystemTap version of that script. However, we will need to be careful while working with userspace backtraces. First of all, we should use <code>-d</code> option to provide path to SystemTap for resolving symbols or <code>--ldd</code> to make it scan library dependencies of traced binary and automatically add them (when some of them are missing, <code>stap</code> utility will provide a hint with full paths).</p>
<p>
Mutexes are also often used in TSLoad which can cause excessive overheads when we try to trace them, especially when we will use <code>ubacktrace()</code> function. You can use <code>STP_NO_OVERLOAD</code> macro definition (which can be passed to <code>stap</code> with <code>-D</code> option) to prevent stap from failing when overheads are big, or you can reduce overheads. In our case we will limit amount of traced callers by using <code>ucallers()</code> function which accepts depth of backtrace as a first argument like <code>ustack()</code> function from backtrace and only collects addresses without resolving them to symbols. We will defer symbol resolving to an aggregation printing.</p>
<p>
Here are our script for SystemTap:</p>
<p>
    <p>
    <div class="well">
<button class="btn" onclick="toggleCode('code2')">+</button>&nbsp; Script file mtxtime.stp <br/><p>
<pre id="code2" class="hide">
global mtxtime[128], mtxlockt;

@define libpthread %( "/lib64/libpthread.so.0" %)
@define tsexperiment %( "/opt/tsload/bin/tsexperiment" %)

probe process(@libpthread).mark("mutex_entry") {
    if(pid() != target()) next;

    mtxtime[tid()] = local_clock_ns();
}

probe process(@libpthread).mark("mutex_acquired") {
    if(pid() != target()) next;

    tm = mtxtime[tid()];
    if(tm == 0) next;

    mtxlockt[ucallers(6)] <<< local_clock_ns() - tm;
    delete mtxtime[tid()];
}

probe process(@tsexperiment).function("experiment_unconfigure") {
    foreach([ub] in mtxlockt) {
        if(@count(mtxlockt[ub]) < 100)
            continue;
        
        println("-=-=-=-=-=-=-=-=-=-=-=-=-");
        print_usyms(ub);
        print(@hist_log(mtxlockt[ub]));
    }
}</pre>
</p>
</div>
</p>
</p>

	</div>
</div>

<!-- TAIL -->

<div class="navbar navbar-bottom">
    <div class="navbar-inner">
        <div class="container">
            <ul class="nav pull-left">
<li><a href="ex5.html"><strong>Prev</strong>(Exercise 5)</a></li>
</ul>
<ul class="nav pull-center">
<li><a href="../index.html"><strong>Up</strong>(Dynamic Tracing with DTrace & SystemTap)</a></li>
</ul>
<ul class="nav pull-right">
<li><a href="ex7.html"><strong>Next</strong>(Exercise 7)</a></li>
</ul>
        </div>
    </div>
</div>

<ul class="breadcrumb">
    <li><a href="https://github.com/myaut/dtrace-stap-book"><small>GitHub</small></a> <span class="divider">|</span></li>
    <li><a href="https://bitbucket.org/sergey_klyaus/dtrace-stap-book"><small>BitBucket</small></a> <span class="divider">|</span></li>
    <li style="float: right; ">
        <small>
        Published under terms of <a href="https://creativecommons.org/licenses/by-nc-sa/3.0/">CC-BY-NC-SA 3.0</a> license.
        </small>
    </li>
</ul>
</body>
</html>