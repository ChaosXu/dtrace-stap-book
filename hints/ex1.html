<html>
<head>
	<meta charset="utf-8" /> 
	<meta http-equiv="Content-Type" content="text/html">
	<meta name="generator" content="TSDoc 0.2">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	
	<title>Appendix A. Exercise hints and solutions </title>
	
	<link rel="stylesheet" href="../bootstrap/css/bootstrap.css" />
	<link href="../bootstrap/css/bootstrap-responsive.css" rel="stylesheet" media="screen,handheld"/>
	
	<script type="text/javascript">
	function toggleCode(id) {
		code = document.getElementById(id);
		hideClass = 'hide';
		
		if(code.classList.contains(hideClass))
			code.classList.remove(hideClass);
		else
			code.classList.add(hideClass);
	}
	</script>
</head>
<body>

<!-- HEADER -->

<div class="navbar">
    <div class="navbar-inner">
	    <div class="container">
			<a class="brand" href="../index.html">Dynamic Tracing with DTrace & SystemTap</a><ul class="nav pull-right">
<li><a href="ex2.html"><strong>Next</strong>(Exercise 2)</a></li>
</ul>
		</div>
    </div>
</div>

<div class="container max-height no-overflow">
	<div id="content" nevow:render="content">
		<p>
<h3>Exercise 1</h3></p>
<p>
This exercise is intended to learn some features of dynamic tracing languages that was discussed in modules 1 and 2. First of all we need to pick probes that we will use in our tracing script. They would be parts of <code>syscall</code> provider/tapset. As you can remember from <a href="../tools/systemtap.html#stap">stap command options</a>, probe parameters can be checked with <code>-L</code> option:<br /></p>
<p>
<pre>
# stap -L 'syscall.open'
syscall.open name:string filename:string flags:long mode:long argstr:string $filename:long int $flags:long int $mode:long int
# stap -L 'syscall.open.return'
syscall.open.return name:string retstr:string $return:long int $filename:long int $flags:long int $mode:long int    
</pre>
</p>
<p>
Same can be done for dtrace with <code>-l</code> option:<br /></p>
<p>
<pre>
# dtrace -l -f openat\* -v
   ID   PROVIDER            MODULE             FUNCTION NAME
14167    syscall                               openat entry
 ...
</pre>
</p>
<p>
Return value (which would represent file descriptor number) will be saved into <code>$return</code> variable in SystemTap and <code>arg1</code> argument in DTrace. We will also need flags values: <code>arg2</code> in DTrace (because they are going third in <code>openat()</code> prototype). In SystemTap you can use either DWARF variable <code>$flags</code> or tapset variable <code>flags</code>. Latter is more stable. <br /></p>
<p>
Similarly, path to opened file will be passed as second <code>openat()</code> argument and will be available in DTrace as <code>arg1</code> or <code>$filename</code>/<code>filename</code> in SystemTap. At the moment of system call, however, file path will be a string which is located in user address space, so to get it in tracing script, you will need to copy it by using <code>copyinstr()</code> in DTrace or one of <code>user_string*()</code> functions. Tapset variable already uses <code>user_string_quoted()</code> to access variable, so we will use it in our scripts.<br /></p>
<p>
Note that data that we want gather is available in two different probes: flags and file path are provided by entry probe, while file descriptor number can only be collected in return probe (SystemTap can provide flags and file path in return probe, but as we mentioned, it depends on compiler optimizations). Since both probes will be executed in the same context, we can use <a href="../lang/vars.html#thread-local-vars">thread-local variables</a>.<br /></p>
<p>
Finally, stringifying flags will require usage of ternary operator <code>?:</code> in DTrace or <code>if/else</code> construct in SystemTap. To concatenate strings, use <code>strjoin</code> from DTrace or string concatenation operator <code>.</code> in SystemTap. <br /></p>
<p>
Here are resulting DTrace script which implements required functionality:<br /></p>
<p>
<div class="well">
<button class="btn" onclick="toggleCode('code1')">+</button>&nbsp; Script file opentrace.d <br/><p>
<pre id="code1" class="hide">
/* These constants are already defined in /usr/lib/dtrace/io.d
inline int O_WRONLY = 1;
inline int O_RDWR = 2;
inline int O_APPEND = 8;
inline int O_CREAT = 256;
*/

this string flag_str;

syscall::openat*:entry {
    self->path = copyinstr(arg1);
    self->flags = arg2;
}

syscall::openat*:return 
{
    this->flags_str = strjoin(
        self->flags & O_WRONLY  
        ? "O_WRONLY" 
        : self->flags & O_RDWR    
            ? "O_RDWR" 
            : "O_RDONLY",
        strjoin(
            self->flags & O_APPEND  ? "|O_APPEND" : "",
            self->flags & O_CREAT   ? "|O_CREAT" : ""));

    printf("%s[%d(%d:%d)] open(\"%s\", %s) = %d\n",
                execname, pid, uid, gid, 
                self->path, this->flags_str, arg1);
}</pre>
</p>
</div>
</p>
<p>
I have used <code>sprintf()</code> to concatenate strings in SystemTap version of a script:<br /></p>
<p>
<div class="well">
<button class="btn" onclick="toggleCode('code2')">+</button>&nbsp; Script file opentrace.stp <br/><p>
<pre id="code2" class="hide">
global O_WRONLY = 1;
global O_RDWR = 2;
global O_APPEND = 1024;
global O_CREAT = 64;

global t_path, t_flags;

probe syscall.open {
    t_path[tid()] = filename;
    t_flags[tid()] = flags;
}

probe syscall.open.return {
    flags = t_flags[tid()];

    if(flags & O_RDWR) {
        flags_str = "O_RDWR";
    }
    else if(flags & O_WRONLY) {
        flags_str = "O_WRONLY";
    }
    else {
        flags_str = "O_RDONLY";
    }
    if(flags & O_APPEND) {
        flags_str = sprintf("%s|%s", flags_str, "O_APPEND");
    }
    if(flags & O_CREAT) {
        flags_str = sprintf("%s|%s", flags_str, "O_CREAT");
    }

    printf("%s[%d(%d:%d)] open(%s, %s) = %d\n",
                execname(), pid(), uid(), gid(), 
                t_path[tid()], flags_str, $return);
}</pre>
</p>
</div>
</p>
<p>
Finally, you will need to add predicates to compare paths with <code>/etc</code> in DTrace by using <code>strstr()</code> subroutine and comparing it with <code>0</code> and SystemTap's <code>ininstr()</code> function.<br /></p>

	</div>
</div>

<!-- TAIL -->

<div class="navbar navbar-bottom">
    <div class="navbar-inner">
        <div class="container">
            <ul class="nav pull-center">
<li><a href="../index.html"><strong>Up</strong>(Dynamic Tracing with DTrace & SystemTap)</a></li>
</ul>
<ul class="nav pull-right">
<li><a href="ex2.html"><strong>Next</strong>(Exercise 2)</a></li>
</ul>
        </div>
    </div>
</div>

<ul class="breadcrumb">
    <li><a href="https://github.com/myaut/dtrace-stap-book"><small>GitHub</small></a> <span class="divider">|</span></li>
    <li><a href="https://bitbucket.org/sergey_klyaus/dtrace-stap-book"><small>BitBucket</small></a> <span class="divider">|</span></li>
    <li style="float: right; ">
        <small>
        Published under terms of <a href="https://creativecommons.org/licenses/by-nc-sa/3.0/">CC-BY-NC-SA 3.0</a> license.
        </small>
    </li>
</ul>
</body>
</html>